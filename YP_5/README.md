# Второй сборный проект. Восстановление золота из руды 
## Цель проекта: 

## Описание проекта
Золотообрабатывающей компании требуется механизм, позволяющий спрогнозировать насколько эффективным будет разработанный технологический процесс обработки золота, чтобы принять решение о целесообразности его внедрения. 

###  Цель проекта
1. Создать модель, которая на основании исследования исторических данных о результатах обработки сырья (характеристики сырья, настройки оборудования, качество итоговых продуктов) обеспечит предсказание эффективности золотообработки на двух стадиях (после флотации и после итоговой очистки). 2. 2. Показателем качества модели принять sMAPE, которую по-возможности минимизировать.

###  Задачи проекта
- Изучить распределение признаков
- Реализовать алгоритм расчета эффективности обагощения
- Сравнить распределений размеров гранул на обучающей и тестовой выборках
- Построить модель(и) регрессии для предсказания эффективности отчистки 
- Подобрать модель(и) используя sMAPE методом кроссвалидации для снижения рисков переобучения
- Проверить модель(и) на тестовой выборке.

###  Этапы проекта:
- Исследование данных:
    - загрузка данных
    - изучение данных (что означают столбцы, к каким этапам обработки относятся)
    - оценка данных (формы, типы, другое)
- Предобработка данных:
    - проверка и переименование названий столбцов
    - проверка и заполнение пропусков
    - проверка на дубликаты
    - проверка на мультиколлинеарность (выявление коррелированных столбцов, выборочное исключение)
    - выявление аномальных значений
    - стратификация по этапам обработки (при необходимости)
    - обработка даты
    - объединение всех ДФ в единый словарь (для автоматизации)
- Исследование данных на предмет применимости для машинного обучения
    - изучение признаков и целевых показателей
    - формиование списков параметров для первой(после флотации) и второй (после финальной очистки) моделей 
    - сравнение признаков в тестовой и тренировочной выборках (размер гранул)
    - анализ суммарных концентраций, обработка аномальных значений
    - нормализация данных (стандартизация)
- Машинное обучение с учителем
    - определение функции, расчитывающей sMAPE
    - подготовка решателя
    - подготовка функции, реализующей выбор лучщих гиперпараметров с использованием итерирования и кроссвалидации
    - перебор моделей регрессии с обучением на разных выборках (с/без стандартизации, с/без корреляции)
    - выбор оптимальной моделии и гиперпараметров
    - проверка моделей на тестовой выборке
    - расчет финального sMAPE
    

###  Описание данных
- Файлы данных
    - /datasets/gold_recovery_train_new.csv. Скачать датасет
    - /datasets/gold_recovery_test_new.csv. Скачать датасет
    - /datasets/gold_recovery_full_new.csv. Скачать датасет

- Целевые признаки
    - эффективность обагощения после флотации
    - эффективность обагощения после финальной отчистки
    
- Независимые признаки:
    - концентрации металлов во входном сырье для этапа флотации (rougher input ),
    - данные о размере гранул сырья для этапа флотации (feed size),
    - данные о реагентах (Xanthate, Sulphate, Depressant)
    - данные о настройках системы:
        - feed rate (скорость подачи)
        - fluid levels (уровень жидкости)
        - air amount (объем воздуха)

- Названия этапов обработки:
    - rougher — флотация
    - primary_cleaner — первичная очистка
    - secondary_cleaner — вторичная очистка
    - final — финальные характеристики

- Названия типов сырья (в зависимости от стадии):
    - input — поставляется на вход этапа
    - output — появляется на выходе этапа
    - tail — хвосты (ненужные очистки после этапа обработки)

  
### Методики расчета
- формула расчета эффективности обагощения: 
![image.png](attachment:image.png)

- формулы метрики:
- по этапам
![image-2.png](attachment:image-2.png)

- финальная:
![image-3.png](attachment:image-3.png)






Целью исследования было снизить риски внедрения неэфективных процессов обработки золотодобывающего сырья за счет оценки(предсказания) эффективности очистки сырья блоками оборудования с заданными характеристика, которые должны быть выполнены машинной моделью. Модель должна была быть разработана на основании исследования исторических данных об обработке золотосодержащего сырья (характеристики сырья, настроек оборудования, итоговых продуктов) и предсказывать(расчитывать) эффективность золотообагощения на двух стадиях (после флотации и после итоговой очистки). Показателем качества модели требовалось принять sMAPE, которая должна быть как можно меньше.

В процесе исследования:

Загружены и изучены исторические данные о параметрах технологических установок золотообработки

Загруженные данные трех ДФ (тренировочного, тестового, полного) оценены, определена их форма, типы, смысловая нагрузка

Выполнена предъобработка, включая:

проверку и переименование названий столбцов (приведение к стилю under_score)
проверку корректности назначенных типов данных (изменен столбец с датой)
поиск полных и неявных дубликатов (не выявлено)
поиск и заполнение пропусков (во всехстолбцах найдены и заполненены методом скользящего окна с размером в сутки(неделю) пропуски c контролем статистических характеристик изменяемых признаков)
выявление аномальных значений (выявлены записи с нулевыми значениями суммарных консентраций и выбросы в размерах гранул сырья, содержащие их записи исключены из ДФ)
удаление неинформативных столбцов, затрудняющих обучение моделей (все столбцы с префиксами calculation и столбец date (непосредственно перед обучением))
поиск коррелированых столбцов (выявлено значительное кол-во неоднократно коррелированных между собой столбцов, созданы отдельные ДФ, отчищенные от корреляции)
объединение всех ДФ(тренировочного, тестового, полного) в единый словарь (для автоматизации)
Проведено исследование данных на предмет применимости для машинного обучения

изучены признаки и целевые показатели, определена принадлежность признаков к одной из трех возможных стадий обработки (флотация, первичная очистка, вторичная очистка)
сформированы списки признаков для машинных моделей:
первой, расчитывающей эффективность очистки после флотации
второй, расчитыающей эффективность очистки после финальной очистки
проведено исследование изменений концентраций металлов в сырье от стадии к стадии, построены и проанализированы распределения плотностей вероятности для каждого металла, типа сырья (входное сырье, получившийся продукт, шаг обработки)
выявлены следующие закономерности:
концентрация золота показывает ожидаемую тенденцию к увеличению в итоговом продукте и относительно стабильную низкую величину в хвостах,
концентрация серебра показывает ожидаемую тенденцию к уменьшению в итоговом продукте и небольшому увеличению в хвостах,
концентрация свинца показывает неожиданную тенденцию к увеличению в итоговом продукте (видимо за счет уменьшения концентрации другого МУСОРА, данных по которому у нас нет) и ожидаемое увеличение в хвостах,
концентрация шлака показывает ожидаемую тенденцию к уменьшению в итоговом продукте и неожидаенное уменьшение в хвостах (за счет значительного увеличение в хвостах концентрации другого МУСОРА),
исследованы суммарные концентрации сырья
проведено сравнение распределений размеров гранул (графически, критерий Манна-Уитни),
для повышения качества и стабильности предсказаний, сокращения различий между размерами гранул в тестовой и тренировочной выборках внесены ограничения модели по размеру гранул(от 20 до 120 условных единиц)
проведена стандартизация количественных признаков методом preprocessing.StandartScaler
Подтотовлен комплект функций, автоматизирующих:

расчет sMAPE, суммарного sMAPE
выявление мультиколлерированных столбцов
перебор гиперпараметров моделей с/без кроссвалидации
выбор лучшей модели для разных комбинаций гиперпараметров, где лучшей считается модель с наименьшим значением sMAPE на тренировочной выборке
Проведено машинное обучение с учителем на моделях регрессии:

модель Lasso
модель Ridge
модель DecisionTreeClassifier
модель LogisticRegression (лог-регрессия)
ElasticNet
Выполнено:

обучение всех моделей на исходном ДФ (с кроссвалидацией)
обучение всех моделей на ДФ со стандартизацией признаков (с кроссвалидацией)
обучение всех моделей на отчищенном от корреляции ДФ без стандартизации (с кроссвалидацией)
обучение всех моделей на отчищенном от корреляции ДФ и стандартизированном ДФ (с кроссвалидацией)
проверка двух наиболее оптимальных моделей (ElasticNet) на тестовой выборке (без кроссвалидации)
расчет этапных и суммарной метрики sMAPE
проверка моделей на адеватность с применением моделей DummyClassifier
По результатам обучения и сравнения моделей можно отметить следующее.

Применение кроссвалидации позволило эффективно решить проблему переобучения
Исключение мультиколлинеарности не принесло ожидаемого эффекта (почти все модели после исключения столбцов продеманстрировали худшие результаты)
Стандартизация также не привела к повышению качества моделей
Метрика sMAPE не зависит от регуляризации данных
Итоговые показатели качества лучших моделей:
после флотации = 8.662766982398082
после финальной очистки = 8.680752761229549
суммарный = 8.478665205751911
Как можно доработать проект:

пропробовать применить другие методы обработки пропусков (ближайшие соседи KNNImputer, алгоритм MICE IterativeImputer, c использованием линейной регрессии https://www.dmitrymakarov.ru/data-analysis/nan-06/#33-sklearn-knnimputer),
попробовать проанализировать графики зависмости эффективности отчистки от каждого из признаков, выделить те из них, на которых зависимость проявляется наиболее ярко и оставить только эти признаки в выборке фичерсов (или увеличить для них весовые коэффициенты),
попробовать применить другие методы масштабирования(регуляризации): полиноминальные (PolynomialFeatures), логарифмирование и взятие квадратного корня от признаков, трансформация Бокса-Кокса (boxcox) (https://nagornyy.me/it/regressionnye-modeli-v-python/),
попробовать округлить все признаки до целых значений и применить линейную модель случайного дерева
проиллюстрировать результативность предсказаний модели графиком Residuals plot (связь между остатками модели и предсказанными значениями),
наприсовать графики прогресса обагощения на этапе исследования концентраций,
сделать подписи к строкам прогресса (tqdm)
